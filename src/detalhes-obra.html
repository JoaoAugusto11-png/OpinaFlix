<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Obra - OpinaFlix</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #181818; color: #fff; font-family: Arial, sans-serif; margin: 0; }
        nav { background: #111; padding: 0 32px; display: flex; align-items: center; height: 56px; justify-content: space-between; }
        .logo { color: #e50914; font-size: 2em; font-weight: bold; text-decoration: none; }
        .container { max-width: 900px; margin: 40px auto; display: flex; gap: 32px; }
        .poster { min-width: 300px; }
        .poster img { width: 100%; border-radius: 12px; box-shadow: 0 2px 16px #0008; }
        .info { flex: 1; }
        .titulo { font-size: 2em; font-weight: bold; margin-bottom: 8px; }
        .ano, .generos, .nota { color: #e50914; font-size: 1.1em; margin-bottom: 8px; }
        .sinopse { margin: 18px 0; color: #ccc; }
        .avaliacoes { margin-top: 32px; }
        .avaliacao-card { background: #222; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .avaliacao-card .usuario { color: #e50914; font-weight: bold; }
        .avaliacao-card .nota { color: #7ed957; font-weight: bold; }
        .avaliacao-card .comentario { margin-top: 6px; color: #fff; }
        .avaliacao-form { margin-top: 32px; background: #222; border-radius: 8px; padding: 16px; }
        .avaliacao-form input, .avaliacao-form textarea { width: 100%; margin-bottom: 8px; border-radius: 4px; border: none; padding: 8px; background: #181818; color: #fff; }
        .avaliacao-form button { background: #e50914; color: #fff; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; }
        .star-rating {
            direction: rtl;
            display: flex;
            justify-content: flex-start;
            font-size: 2em;
            margin-bottom: 8px;
            gap: 2px;
        }
        .star-rating .star {
            cursor: pointer;
            color: #444;
            transition: color 0.2s;
        }
        .star-rating .star.selected,
        .star-rating .star.hovered {
            color: #ffd700;
        }
        @media (max-width: 900px) {
            .container { flex-direction: column; align-items: center; }
            .poster { min-width: 180px; }
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html" class="logo">OpinaFlix</a>
        <ul style="list-style:none;display:flex;gap:32px;margin:0;padding:0;">
            <li><a href="filmes-series.html" style="color:#fff;text-decoration:none;">Filmes e Séries</a></li>
            <li><a href="colecoes.html" style="color:#fff;text-decoration:none;">Coleções</a></li>
            <li><a href="conteudo-novo.html" style="color:#fff;text-decoration:none;">Conteúdo Novo</a></li>
            <li><a href="review-galera.html" style="color:#fff;text-decoration:none;">Review da Galera</a></li>
        </ul>
        <button id="btn-login" onclick="window.location.href='login.html'" style="margin-left: 16px; background: #e50914; color: #fff; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer;">
            Entrar na sua conta
        </button>
    </nav>
    <div class="container" id="detalhes-container">
        <!-- Conteúdo dinâmico aqui -->
    </div>
    <div class="avaliacoes" id="avaliacoes-container">
        <!-- Avaliações dos usuários -->
    </div>
    <div class="avaliacao-form" id="avaliacao-form-container" style="max-width:900px;margin:32px auto 0 auto;display:none;">
        <h3>Deixe sua avaliação</h3>
        <form id="form-avaliacao">
            <div class="star-rating" id="star-rating">
                <!-- Estrelas serão geradas via JS -->
            </div>
            <input type="hidden" id="nota" name="nota" required>
            <textarea id="comentario" placeholder="Comentário" rows="3"></textarea>
            <button type="submit">Enviar Avaliação</button>
        </form>
        <div id="mensagem-avaliacao"></div>
    </div>
    <footer style="background:#111; color:#ccc; text-align:center; padding:32px 0; margin-top:48px;">
        <div style="margin-bottom: 12px;">
            <a href="https://facebook.com" target="_blank" style="margin:0 12px; color:#fff; font-size:1.7em;">
                <i class="fab fa-facebook"></i>
            </a>
            <a href="https://instagram.com" target="_blank" style="margin:0 12px; color:#fff; font-size:1.7em;">
                <i class="fab fa-instagram"></i>
            </a>
            <a href="https://youtube.com" target="_blank" style="margin:0 12px; color:#fff; font-size:1.7em;">
                <i class="fab fa-youtube"></i>
            </a>
        </div>
        <div style="font-size:1em; color:#aaa;">
            &copy; 2025 OpinaFlix. Todos os direitos reservados.
        </div>
    </footer>
    <script>
    // Troque pela sua chave TMDB
    const tmdbApiKey = '25aa122e262151673e05f311eaeb56ba';

    // Pega o id da obra da URL: detalhes-obra.html?id=123
    const params = new URLSearchParams(window.location.search);
    const obraId = params.get('id');
    const tipo = params.get('tipo') || 'movie'; // padrão: filme

    async function carregarDetalhes() {
        if (!obraId) {
            document.getElementById('detalhes-container').innerHTML = '<div style="color:#e50914;">Obra não encontrada.</div>';
            return;
        }
        // Busca detalhes do filme ou série
        const url = `https://api.themoviedb.org/3/${tipo}/${obraId}?api_key=${tmdbApiKey}&language=pt-BR`;
        const resp = await fetch(url);
        if (!resp.ok) {
            document.getElementById('detalhes-container').innerHTML = '<div style="color:#e50914;">Obra não encontrada.</div>';
            return;
        }
        const obra = await resp.json();
        const poster = obra.poster_path ? `https://image.tmdb.org/t/p/w400${obra.poster_path}` : 'https://via.placeholder.com/400x600?text=Sem+Imagem';
        const generos = obra.genres ? obra.genres.map(g => g.name).join(', ') : '';
        const titulo = obra.title || obra.name;
        const ano = (obra.release_date || obra.first_air_date || '').slice(0,4);
        const sinopse = obra.overview || 'Sem sinopse disponível.';
        const nota = obra.vote_average ? obra.vote_average.toFixed(1) : '-';

        const html = `
            <div class="poster">
                <img src="${poster}" alt="${titulo}">
            </div>
            <div class="info">
                <div class="titulo">${titulo}</div>
                <div class="ano">${ano}</div>
                <div class="generos">${generos}</div>
                <div class="nota"><i class="fas fa-star" style="color:#ffd700;"></i> ${nota}/10</div>
                <div class="sinopse">${sinopse}</div>
            </div>
        `;
        document.getElementById('detalhes-container').innerHTML = html;
        document.getElementById('avaliacao-form-container').style.display = 'block';
    }

    // Carregar avaliações do backend
    async function carregarAvaliacoes() {
        if (!obraId) return;
        const url = `http://localhost:3001/api/avaliacoes/${obraId}`;
        try {
            const resp = await fetch(url);
            const avaliacoes = await resp.json();
            let html = '<h3 style="color:#e50914;">Avaliações da comunidade</h3>';
            if (avaliacoes.length === 0) {
                html += '<div style="color:#ccc;">Seja o primeiro a avaliar!</div>';
            } else {
                avaliacoes.forEach(a => {
                    html += `
                        <div class="avaliacao-card">
                            <span class="usuario">${a.usuarioNome || 'Usuário'}</span>
                            <span class="nota"> - Nota: ${a.nota}</span>
                            <div class="comentario">${a.comentario || ''}</div>
                        </div>
                    `;
                });
            }
            document.getElementById('avaliacoes-container').innerHTML = html;
        } catch {
            document.getElementById('avaliacoes-container').innerHTML = '<div style="color:#e50914;">Erro ao carregar avaliações.</div>';
        }
    }

    // Enviar avaliação
    document.getElementById('form-avaliacao').addEventListener('submit', async function(event) {
        event.preventDefault();
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        if (!usuario) {
            document.getElementById('mensagem-avaliacao').textContent = 'Você precisa estar logado para avaliar.';
            document.getElementById('mensagem-avaliacao').style.color = '#e50914';
            return;
        }
        const nota = selectedRating;
        const comentario = document.getElementById('comentario').value;
        const resposta = await fetch('http://localhost:3001/api/avaliacoes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuarioId: usuario.id, obraId, nota, comentario })
        });
        const resultado = await resposta.json();
        if (resposta.ok) {
            document.getElementById('mensagem-avaliacao').textContent = 'Avaliação enviada!';
            document.getElementById('mensagem-avaliacao').style.color = 'lightgreen';
            document.getElementById('form-avaliacao').reset();
            carregarAvaliacoes();
        } else {
            document.getElementById('mensagem-avaliacao').textContent = resultado.message || 'Erro ao enviar avaliação.';
            document.getElementById('mensagem-avaliacao').style.color = '#e50914';
        }
    });

    // Estrelas de avaliação 1-10
    const starRating = document.getElementById('star-rating');
    const notaInput = document.getElementById('nota');
    let selectedRating = 0;

    function renderStars(rating = 0, hover = false) {
        starRating.innerHTML = '';
        for (let i = 10; i >= 1; i--) {
            const star = document.createElement('span');
            star.classList.add('star');
            star.innerHTML = '<i class="fas fa-star"></i>';
            if (i <= rating) star.classList.add(hover ? 'hovered' : 'selected');
            star.dataset.value = i;
            star.addEventListener('mouseenter', () => renderStars(i, true));
            star.addEventListener('mouseleave', () => renderStars(selectedRating));
            star.addEventListener('click', () => {
                selectedRating = i;
                notaInput.value = i;
                renderStars(selectedRating);
            });
            starRating.appendChild(star);
        }
    }
    renderStars();

    carregarDetalhes();
    carregarAvaliacoes();
    </script>
</body>
</html>